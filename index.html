<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Game Edukasi Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .check-anim { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .check-anim:hover { transform: scale(1.1); }
    </style>
</head>
<body class="bg-[#0f172a] text-white min-h-screen flex flex-col p-4 md:p-8">

    <div class="max-w-7xl w-full mx-auto flex justify-end mb-4">
        <div id="auth-container">
            <button onclick="showLoginMenu()" id="btn-login" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold text-sm transition flex items-center gap-2 shadow-lg ring-2 ring-blue-400/50">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                Masuk / Daftar Akun
            </button>

            <div id="user-info" class="hidden flex items-center gap-3 bg-slate-800 px-4 py-2 rounded-full border border-slate-700 shadow-xl">
                <div class="flex flex-col text-right">
                    <span id="user-name" class="text-xs font-bold text-white leading-tight">User</span>
                    <span class="text-[10px] text-green-400 flex items-center justify-end gap-1">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online
                    </span>
                </div>
                <img id="user-photo" class="w-9 h-9 rounded-full border-2 border-blue-500 bg-slate-600" src="">
                <button onclick="logout()" class="ml-2 text-xs bg-red-600 hover:bg-red-500 text-white px-3 py-1.5 rounded-full font-bold transition shadow-md">
                    Keluar
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl w-full mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <div class="lg:col-span-3">
            <header class="mb-10 border-b border-slate-700 pb-6">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">
                    Zona Belajar Interaktif
                </h1>
                <p class="text-slate-400 text-lg">Platform belajar seru dengan penyimpanan skor otomatis.</p>
            </header>

            <div id="main-container" class="space-y-12">
                <div class="text-slate-500 loading pt-10 text-center text-xl">
                    üì° Memindai data terbaru...
                </div>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 sticky top-8 h-[85vh] flex flex-col shadow-xl backdrop-blur-sm">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-yellow-400 flex items-center gap-2">
                        üèÜ Riwayat Skor
                    </h2>
                    <button onclick="adminMode()" id="btn-admin" class="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1 rounded transition-colors border border-slate-600">
                        ‚öôÔ∏è Kelola
                    </button>
                </div>

                <div id="admin-panel" class="hidden mb-4 bg-red-900/40 p-4 rounded-xl border border-red-500/50">
                    <div class="flex justify-between items-center mb-3 border-b border-red-500/30 pb-2">
                        <span class="text-xs font-bold text-red-200 uppercase tracking-wider">Mode Admin</span>
                        <button onclick="exitAdmin()" class="text-xs text-red-300 hover:text-white">‚úï Tutup</button>
                    </div>
                    <button onclick="deleteSelected()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2.5 rounded-lg mb-2 shadow-lg flex items-center justify-center gap-2">
                        <span>üóëÔ∏è</span> Hapus Yang Dipilih
                    </button>
                    <button onclick="deleteAll()" class="w-full bg-slate-800 border border-red-500 text-red-400 hover:bg-red-900/50 text-xs font-bold py-2.5 rounded-lg transition">
                        üí• Hapus SEMUA
                    </button>
                </div>

                <div class="overflow-y-auto flex-grow pr-2 space-y-3 relative custom-scroll" id="history-container">
                    <div class="flex flex-col items-center justify-center h-40 text-slate-500">
                        <svg class="w-12 h-12 mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                        <p class="text-sm">Silakan login untuk<br>melihat riwayat.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="game-modal" class="fixed inset-0 z-50 bg-black/95 hidden flex items-center justify-center p-2 md:p-4 backdrop-blur-md">
        <div class="bg-slate-900 w-full max-w-5xl h-[95vh] rounded-2xl border border-slate-600 flex flex-col relative shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üéÆ</span>
                    <h3 id="modal-title" class="font-bold text-lg md:text-xl text-white">Memuat...</h3>
                </div>
                <button onclick="closeGame()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded-lg text-sm font-bold transition-colors shadow-lg">
                    KELUAR ‚ùå
                </button>
            </div>
            <iframe id="game-frame" src="" class="w-full flex-grow bg-[#0f172a]" frameborder="0"></iframe>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==========================================
        // 1. KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyApJpiuRb_lfF8tWFEnzZnykKkKvcMB9-s",
            authDomain: "zona-belajar-f4b36.firebaseapp.com",
            databaseURL: "https://zona-belajar-f4b36-default-rtdb.firebaseio.com/",
            projectId: "zona-belajar-f4b36",
            storageBucket: "zona-belajar-f4b36.firebasestorage.app",
            messagingSenderId: "921644645673",
            appId: "1:921644645673:web:b01e1909a1138a1b6a8b38"
        };

        // Inisialisasi
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ==========================================
        // 2. SISTEM LOGIN BARU (DIROMBAK TOTAL)
        // ==========================================
        
        // Menu Pilihan Login
        function showLoginMenu() {
            Swal.fire({
                title: 'Selamat Datang!',
                text: 'Pilih metode masuk yang Anda inginkan',
                showCancelButton: true,
                showConfirmButton: false,
                cancelButtonText: 'Batal',
                html: `
                    <div class="flex flex-col gap-3 mt-4">
                        <button onclick="handleGoogleLogin()" class="bg-white text-gray-700 border border-gray-300 font-bold py-3 px-4 rounded-xl hover:bg-gray-50 flex items-center justify-center gap-3 transition">
                            <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                            Masuk dengan Google
                        </button>
                        <button onclick="handleEmailLogin()" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 flex items-center justify-center gap-3 transition">
                            üìß Masuk dengan Email & Password
                        </button>
                        <button onclick="handleMagicLink()" class="bg-teal-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-teal-700 flex items-center justify-center gap-3 transition">
                            ‚ú® Login Tanpa Password (Link)
                        </button>
                        <div class="relative flex py-2 items-center">
                            <div class="flex-grow border-t border-gray-300"></div>
                            <span class="flex-shrink-0 mx-4 text-gray-400 text-xs">Belum punya akun?</span>
                            <div class="flex-grow border-t border-gray-300"></div>
                        </div>
                        <button onclick="handleRegister()" class="bg-slate-800 text-white font-bold py-3 px-4 rounded-xl hover:bg-slate-900 transition border border-slate-600">
                            üìù Daftar Akun Baru
                        </button>
                    </div>
                `
            });
        }

        // --- A. Login Google ---
        function handleGoogleLogin() {
            Swal.close(); // Tutup menu
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(err => Swal.fire("Gagal", err.message, "error"));
        }

        // --- B. Login Email & Password ---
        async function handleEmailLogin() {
            const { value: formValues } = await Swal.fire({
                title: 'Masuk Akun',
                html: `
                    <input id="login-email" class="swal2-input" placeholder="Email Address">
                    <input id="login-pass" class="swal2-input" type="password" placeholder="Password">
                `,
                confirmButtonText: 'Masuk',
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: () => {
                    return [
                        document.getElementById('login-email').value,
                        document.getElementById('login-pass').value
                    ]
                }
            });

            if (formValues) {
                const [email, pass] = formValues;
                if(!email || !pass) return Swal.fire("Error", "Isi semua kolom!", "warning");
                
                auth.signInWithEmailAndPassword(email, pass)
                    .then(() => Swal.fire({ icon: 'success', title: 'Berhasil Masuk!', timer: 1500, showConfirmButton: false }))
                    .catch(err => showErrorMessage(err));
            }
        }

        // --- C. Daftar Akun Baru ---
        async function handleRegister() {
            const { value: formValues } = await Swal.fire({
                title: 'Daftar Akun Baru',
                html: `
                    <input id="reg-email" class="swal2-input" placeholder="Email Address">
                    <input id="reg-pass" class="swal2-input" type="password" placeholder="Password (Min. 6 Karakter)">
                `,
                confirmButtonText: 'Daftar Sekarang',
                confirmButtonColor: '#10b981', // Hijau
                showCancelButton: true,
                preConfirm: () => {
                    return [
                        document.getElementById('reg-email').value,
                        document.getElementById('reg-pass').value
                    ]
                }
            });

            if (formValues) {
                const [email, pass] = formValues;
                if(!email || !pass) return Swal.fire("Error", "Isi semua kolom!", "warning");

                auth.createUserWithEmailAndPassword(email, pass)
                    .then(() => Swal.fire("Sukses!", "Akun berhasil dibuat. Anda sudah login.", "success"))
                    .catch(err => showErrorMessage(err));
            }
        }

        // --- D. Magic Link (Login Tanpa Password) ---
        async function handleMagicLink() {
            const { value: email } = await Swal.fire({
                title: 'Login Tanpa Password',
                input: 'email',
                inputLabel: 'Masukkan email, kami kirim link login ajaib.',
                inputPlaceholder: 'nama@email.com',
                confirmButtonText: 'Kirim Link',
                showCancelButton: true
            });

            if (email) {
                const settings = {
                    url: window.location.href, // Kembali ke halaman ini
                    handleCodeInApp: true
                };

                auth.sendSignInLinkToEmail(email, settings)
                    .then(() => {
                        window.localStorage.setItem('emailForSignIn', email);
                        Swal.fire('Terkirim!', 'Cek email Anda (termasuk folder Spam). Klik link di sana untuk masuk.', 'success');
                    })
                    .catch(err => showErrorMessage(err));
            }
        }

        // Helper: Pesan Error Bahasa Indonesia
        function showErrorMessage(error) {
            let msg = error.message;
            if(error.code === 'auth/wrong-password') msg = "Password salah.";
            if(error.code === 'auth/user-not-found') msg = "Akun tidak ditemukan. Silakan daftar dulu.";
            if(error.code === 'auth/email-already-in-use') msg = "Email ini sudah terdaftar.";
            if(error.code === 'auth/weak-password') msg = "Password terlalu pendek (Min 6 karakter).";
            if(error.code === 'auth/invalid-email') msg = "Format email tidak valid.";
            Swal.fire("Gagal", msg, "error");
        }

        // Listener Status Auth
        auth.onAuthStateChanged(user => {
            if (user) {
                // User Login
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                
                const name = user.displayName || user.email.split('@')[0];
                document.getElementById('user-name').innerText = name;
                document.getElementById('user-photo').src = user.photoURL || `https://ui-avatars.com/api/?name=${name}&background=random&color=fff`;
                
                // Cek Login Link
                if (auth.isSignInWithEmailLink(window.location.href)) {
                    let email = window.localStorage.getItem('emailForSignIn');
                    if (!email) email = window.prompt('Konfirmasi email Anda:');
                    auth.signInWithEmailLink(email, window.location.href)
                        .then(() => {
                            window.localStorage.removeItem('emailForSignIn');
                            window.history.replaceState({}, document.title, window.location.pathname); // Bersihkan URL
                        });
                }

                loadHistoryRealtime(user.uid);
            } else {
                // User Logout
                document.getElementById('btn-login').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('history-container').innerHTML = `
                    <div class="flex flex-col items-center justify-center h-40 text-slate-500">
                        <p class="text-sm">Silakan login untuk<br>melihat riwayat.</p>
                    </div>`;
            }
        });

        function logout() {
            auth.signOut();
            exitAdmin();
        }

        // ==========================================
        // 3. DATABASE & GAME LOGIC
        // ==========================================
        
        let currentUserUid = null;
        let isAdmin = false;
        let selectedItems = new Set(); 

        function loadHistoryRealtime(uid) {
            currentUserUid = uid;
            const historyRef = db.ref('history/' + uid);
            
            historyRef.on('value', (snapshot) => {
                const container = document.getElementById('history-container');
                const dataRaw = snapshot.val();

                if (!dataRaw) {
                    container.innerHTML = '<p class="text-slate-500 text-sm text-center mt-10">Belum ada data.</p>';
                    return;
                }

                const dataArray = Object.keys(dataRaw).map(key => ({
                    id: key, ...dataRaw[key]
                })).sort((a, b) => b.createdAt - a.createdAt);

                container.innerHTML = '';
                
                dataArray.forEach(data => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "bg-slate-700/40 p-3 rounded-xl border border-slate-600/50 flex items-center gap-3 group hover:bg-slate-700/60 transition-all";
                    
                    const checkbox = `<input type="checkbox" class="admin-check w-5 h-5 accent-red-500 rounded cursor-pointer ${isAdmin ? 'block' : 'hidden'}" onchange="toggleSelect('${data.id}')">`;
                    
                    const content = `
                        <div class="flex-grow">
                            <h4 class="font-bold text-sm text-teal-300 line-clamp-1">${data.game}</h4>
                            <p class="text-[10px] text-slate-400">${data.dateStr}</p>
                        </div>
                        <div class="text-right bg-slate-800 px-2 py-1 rounded-lg border border-slate-700">
                            <span class="block text-lg font-bold text-yellow-400 leading-none">${data.score}</span>
                        </div>
                    `;
                    itemDiv.innerHTML = checkbox + content;
                    container.appendChild(itemDiv);
                });
            });
        }

        function saveToFirebase(game, score) {
            const user = auth.currentUser;
            if (!user) return;
            
            db.ref('history/' + user.uid).push({
                game: game,
                score: parseInt(score),
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                dateStr: new Date().toLocaleDateString('id-ID')
            });
        }

        // ==========================================
        // 4. ADMIN & GAME SYSTEM
        // ==========================================
        const GITHUB_USERNAME = 'tanzilhuda1215-source'; 
        const REPO_NAME = 'SisLearn';                    
        const FOLDER_NAME = 'games';
        const CUSTOM_ICONS = {
            "space.html": "üöÄ", "glass.html": "üíé", "Pronouncation-Games.html": "üó£Ô∏è",
            "kuis tanda koma.html": "üìù", "Quiz kata sifat kata benda.html": "grammar"
        };

        // ... (Kode loadContent, openGame, dll tetap sama) ...
        // Agar tidak terlalu panjang, saya persingkat bagian yang tidak berubah.
        // Logika Admin:
        
        async function adminMode() {
            if (!auth.currentUser) return Swal.fire("Akses Ditolak", "Login dulu bos!", "warning");
            if (isAdmin) { exitAdmin(); return; }

            const { value: password } = await Swal.fire({
                title: 'Password Admin',
                input: 'password',
                inputPlaceholder: 'Ketik: admin',
                showCancelButton: true
            });

            if (password === "admin") {
                isAdmin = true;
                selectedItems.clear();
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('btn-admin').classList.add('bg-red-600', 'text-white', 'border-red-500');
                document.getElementById('btn-admin').innerText = "Tutup Admin";
                document.querySelectorAll('.admin-check').forEach(el => el.classList.remove('hidden'));
                Swal.fire({icon: 'success', title: 'Mode Admin Aktif', timer: 1500, showConfirmButton: false});
            } else if (password) {
                Swal.fire("Salah Password!", "", "error");
            }
        }

        function exitAdmin() {
            isAdmin = false;
            selectedItems.clear();
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('btn-admin').classList.remove('bg-red-600', 'text-white', 'border-red-500');
            document.getElementById('btn-admin').innerText = "‚öôÔ∏è Kelola";
            document.querySelectorAll('.admin-check').forEach(el => {
                el.classList.add('hidden');
                el.checked = false;
            });
        }

        window.toggleSelect = function(id) {
            if (selectedItems.has(id)) selectedItems.delete(id);
            else selectedItems.add(id);
        }

        async function deleteSelected() {
            if (selectedItems.size === 0) return Swal.fire("Pilih dulu data yang mau dihapus.", "", "info");
            
            const result = await Swal.fire({
                title: `Hapus ${selectedItems.size} Data?`,
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hapus!'
            });

            if (result.isConfirmed) {
                const updates = {};
                selectedItems.forEach(id => updates[`history/${auth.currentUser.uid}/${id}`] = null);
                await db.ref().update(updates);
                Swal.fire("Terhapus!", "", "success");
                selectedItems.clear();
            }
        }

        async function deleteAll() {
            const result = await Swal.fire({
                title: 'HAPUS SEMUA?',
                text: "Semua riwayat skor Anda akan hilang permanen!",
                icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Hancurkan!'
            });

            if (result.isConfirmed) {
                await db.ref(`history/${auth.currentUser.uid}`).remove();
                Swal.fire("Bersih!", "", "success");
            }
        }

        // --- FUNGSI LOAD CONTENT & SPY (Sama) ---
        let spyInterval = null;
        let currentGameTitle = "";

        function parseFileInfo(filename) {
            const dateRegex = /^(\d{4})-(\d{2})-(\d{2})-(.*)\.html$/;
            const match = filename.match(dateRegex);
            if (match) {
                const dateObj = new Date(match[1], match[2] - 1, match[3]);
                return { dateObj, dateDisplay: dateObj.toLocaleDateString('id-ID'), cleanName: match[4].replace(/-/g, ' ').toUpperCase() };
            }
            return { dateObj: new Date(0), dateDisplay: "", cleanName: filename.replace('.html', '').replace(/-/g, ' ').toUpperCase() };
        }

        async function loadContent() {
            const mainContainer = document.getElementById('main-container');
            const rootApiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FOLDER_NAME}`;
            try {
                const response = await fetch(rootApiUrl);
                if (!response.ok) throw new Error("Gagal koneksi ke GitHub.");
                const items = await response.json();
                mainContainer.innerHTML = ''; 
                const files = items.filter(i => i.type === 'file' && i.name.endsWith('.html'));
                const folders = items.filter(i => i.type === 'dir');
                if (files.length > 0) renderCategorySection("Game Umum", files);
                await Promise.all(folders.map(async (folder) => {
                    const resp = await fetch(folder.url);
                    const folderItems = await resp.json();
                    const gameInFolder = folderItems.filter(i => i.type === 'file' && i.name.endsWith('.html'));
                    if (gameInFolder.length > 0) renderCategorySection(folder.name.replace(/-/g, ' ').toUpperCase(), gameInFolder);
                }));
            } catch (error) { mainContainer.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`; }
        }

        function renderCategorySection(title, files) {
            const container = document.getElementById('main-container');
            const processed = files.map(f => ({ ...f, ...parseFileInfo(f.name) })).sort((a, b) => b.dateObj - a.dateObj);
            let html = `<div class="animate-fade-in order-last"><div class="flex items-center gap-4 mb-6 mt-8"><div class="h-8 w-1 bg-teal-500 rounded-full"></div><h2 class="text-2xl font-bold">${title}</h2></div><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
            processed.forEach(f => {
                let icon = CUSTOM_ICONS[f.name] || (f.cleanName.includes("MATH") ? "üßÆ" : "üéÆ");
                html += `<div class="bg-slate-800 rounded-2xl p-5 border border-slate-700 hover:border-teal-400 transition-all hover:-translate-y-1 flex flex-col h-full">
                    <div class="flex justify-between mb-4"><span class="text-4xl bg-slate-900/50 w-14 h-14 rounded-xl flex items-center justify-center">${icon}</span>${f.dateDisplay ? `<span class="text-[10px] bg-slate-900 px-2 py-1 rounded border border-teal-900/50 h-fit text-teal-300">üìÖ ${f.dateDisplay}</span>` : ''}</div>
                    <h3 class="text-lg font-bold mb-2">${f.cleanName}</h3>
                    <div class="mt-auto pt-4"><button onclick="openGame('${f.path}', '${f.cleanName}')" class="w-full bg-gradient-to-r from-blue-600 to-teal-600 text-white font-bold py-2 rounded-xl shadow-lg active:scale-95">Mainkan üöÄ</button></div>
                </div>`;
            });
            container.innerHTML += html + `</div></div>`;
        }

        function openGame(path, title) {
            document.getElementById('game-modal').classList.remove('hidden');
            document.getElementById('game-frame').src = path;
            document.getElementById('modal-title').innerText = title;
            currentGameTitle = title;
            startSpying();
        }
        function closeGame() {
            document.getElementById('game-modal').classList.add('hidden');
            document.getElementById('game-frame').src = "";
            clearInterval(spyInterval);
        }

        function startSpying() {
            clearInterval(spyInterval);
            let scoreCaptured = false;
            spyInterval = setInterval(() => {
                if(scoreCaptured) return;
                const iframe = document.getElementById('game-frame');
                try {
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    if (doc) {
                        const resultScreen = doc.getElementById('result-screen');
                        if (resultScreen && !resultScreen.classList.contains('hidden')) {
                            const scoreEl = doc.getElementById('final-score');
                            if (scoreEl) {
                                saveToFirebase(currentGameTitle, scoreEl.innerText);
                                scoreCaptured = true;
                                clearInterval(spyInterval);
                                Swal.fire("Misi Selesai!", `Skor ${scoreEl.innerText} tersimpan ke cloud! ‚òÅÔ∏è`, "success");
                            }
                        }
                    }
                } catch (e) {}
            }, 1000);
        }

        loadContent();
    </script>
</body>
</html>
