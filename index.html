<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Game Edukasi Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap');
        body { font-family: 'Outfit', sans-serif; }
        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .check-anim { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .check-anim:hover { transform: scale(1.1); }
    </style>
</head>
<body class="bg-[#0f172a] text-white min-h-screen flex flex-col p-4 md:p-8">

    <div class="max-w-7xl w-full mx-auto flex justify-end mb-4">
        <div id="auth-container">
            <button onclick="showAuthModal()" id="btn-login" class="bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold text-sm transition flex items-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
                Login / Daftar
            </button>

            <div id="user-info" class="hidden flex items-center gap-3 bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
                <div class="flex flex-col text-right">
                    <span id="user-name" class="text-xs font-bold text-white leading-tight">User</span>
                    <span class="text-[10px] text-slate-400">Online</span>
                </div>
                <img id="user-photo" class="w-8 h-8 rounded-full border-2 border-blue-500 bg-slate-600" src="">
                <button onclick="logout()" class="ml-2 text-xs text-red-400 hover:text-red-300 font-bold bg-red-900/20 px-2 py-1 rounded border border-red-900/50 hover:bg-red-900/40 transition">
                    Keluar
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl w-full mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <div class="lg:col-span-3">
            <header class="mb-10 border-b border-slate-700 pb-6">
                <h1 class="text-4xl md:text-5xl font-extrabold mb-3 text-transparent bg-clip-text bg-gradient-to-r from-teal-400 to-blue-500">
                    Zona Belajar Interaktif
                </h1>
                <p class="text-slate-400 text-lg">Materi terbaru selalu muncul di urutan pertama.</p>
            </header>

            <div id="main-container" class="space-y-12">
                <div class="text-slate-500 loading pt-10 text-center text-xl">
                    üì° Memindai data terbaru...
                </div>
            </div>
        </div>

        <div class="lg:col-span-1">
            <div class="bg-slate-800/50 border border-slate-700 rounded-2xl p-6 sticky top-8 h-[85vh] flex flex-col shadow-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-yellow-400 flex items-center gap-2">
                        üèÜ Riwayat Skor
                    </h2>
                    <button onclick="adminMode()" id="btn-admin" class="text-xs bg-slate-700 hover:bg-red-600 hover:text-white px-2 py-1 rounded transition-colors text-slate-400">
                        ‚öôÔ∏è Kelola
                    </button>
                </div>

                <div id="admin-panel" class="hidden mb-4 bg-red-900/30 p-3 rounded-lg border border-red-500/50">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-red-200 uppercase">Mode Administrator</span>
                        <button onclick="exitAdmin()" class="text-[10px] text-slate-400 hover:text-white">Tutup</button>
                    </div>
                    <button onclick="deleteSelected()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs font-bold py-2 rounded mb-2">
                        Hapus Yang Dipilih üóëÔ∏è
                    </button>
                    <button onclick="deleteAll()" class="w-full border border-red-500 text-red-300 hover:bg-red-500/20 text-xs font-bold py-2 rounded">
                        Hapus SEMUA üí•
                    </button>
                </div>

                <div class="overflow-y-auto flex-grow pr-2 space-y-3 relative" id="history-container">
                    <p class="text-slate-500 text-sm text-center mt-10 italic">Login untuk melihat riwayat.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="game-modal" class="fixed inset-0 z-50 bg-black/95 hidden flex items-center justify-center p-2 md:p-4 backdrop-blur-md">
        <div class="bg-slate-900 w-full max-w-5xl h-[95vh] rounded-2xl border border-slate-600 flex flex-col relative shadow-2xl overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-slate-700 bg-slate-800">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">üéÆ</span>
                    <h3 id="modal-title" class="font-bold text-lg md:text-xl text-white">Memuat...</h3>
                </div>
                <button onclick="closeGame()" class="bg-red-600 hover:bg-red-500 text-white px-5 py-2 rounded-lg text-sm font-bold transition-colors shadow-lg">
                    KELUAR ‚ùå
                </button>
            </div>
            <iframe id="game-frame" src="" class="w-full flex-grow bg-[#0f172a]" frameborder="0"></iframe>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // ==========================================
        // KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyApJpiuRb_lfF8tWFEnzZnykKkKvcMB9-s",
            authDomain: "zona-belajar-f4b36.firebaseapp.com",
            databaseURL: "https://zona-belajar-f4b36-default-rtdb.firebaseio.com/",
            projectId: "zona-belajar-f4b36",
            storageBucket: "zona-belajar-f4b36.firebasestorage.app",
            messagingSenderId: "921644645673",
            appId: "1:921644645673:web:b01e1909a1138a1b6a8b38"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.database(); 

        // ==========================================
        // LOGIKA AUTHENTICATION LENGKAP
        // ==========================================
        let currentUser = null;
        let isAdmin = false;
        let selectedItems = new Set(); 

        // 1. Cek Status Login Saat Load
        auth.onAuthStateChanged(user => {
            if (user) {
                // User Sedang Login
                currentUser = user;
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                
                const displayName = user.displayName || user.email.split('@')[0];
                document.getElementById('user-name').innerText = displayName;
                
                const photoURL = user.photoURL || `https://ui-avatars.com/api/?name=${displayName}&background=random&color=fff`;
                document.getElementById('user-photo').src = photoURL;
                
                loadHistoryRealtime(); 
            } else {
                // User Belum Login
                currentUser = null;
                document.getElementById('btn-login').classList.remove('hidden');
                document.getElementById('user-info').classList.add('hidden');
                document.getElementById('history-container').innerHTML = 
                    '<p class="text-slate-500 text-sm text-center mt-10">Silakan Login untuk melihat riwayat.</p>';
            }
        });

        // 2. Fungsi Menampilkan Pop-Up Login (SUDAH DIPERBAIKI)
        async function showAuthModal() {
            const result = await Swal.fire({
                title: 'Akses Akun',
                html: `
                    <input id="swal-email" class="swal2-input" placeholder="Email Anda">
                    <input id="swal-password" class="swal2-input" placeholder="Password" type="password">
                `,
                showCancelButton: true,
                showDenyButton: true, // Tombol Daftar
                confirmButtonText: 'Masuk',
                denyButtonText: 'Daftar Baru',
                cancelButtonText: 'Batal',
                confirmButtonColor: '#2563eb',
                denyButtonColor: '#16a34a',
                footer: '<a href="#" onclick="sendMagicLink(); return false;" class="text-blue-500 hover:underline">Lupa Password / Login Tanpa Password?</a>',
                preConfirm: () => {
                    return {
                        email: document.getElementById('swal-email').value,
                        password: document.getElementById('swal-password').value
                    };
                }
            });

            if (result.isConfirmed) {
                // --- LOGIKA LOGIN (MASUK) ---
                const { email, password } = result.value;
                if (!email || !password) return Swal.fire("Error", "Email & Password harus diisi", "warning");
                
                auth.signInWithEmailAndPassword(email, password)
                    .then(() => Swal.fire({icon: 'success', title: 'Berhasil Masuk!', timer: 1500, showConfirmButton: false}))
                    .catch(err => Swal.fire("Gagal Masuk", translateError(err.code), "error"));

            } else if (result.isDenied) {
                // --- LOGIKA DAFTAR BARU ---
                const { email, password } = result.value;
                if (!email || !password) return Swal.fire("Error", "Email & Password harus diisi", "warning");

                auth.createUserWithEmailAndPassword(email, password)
                    .then(() => Swal.fire("Selamat Datang!", "Akun berhasil dibuat.", "success"))
                    .catch(err => Swal.fire("Gagal Daftar", translateError(err.code), "error"));
            }
        }

        // 3. Logika Login Tanpa Password (Magic Link)
        async function sendMagicLink() {
            Swal.close(); // Tutup modal login dulu
            
            const { value: email } = await Swal.fire({
                title: 'Login Tanpa Password',
                input: 'email',
                inputLabel: 'Masukkan email Anda, kami akan kirimkan link login.',
                inputPlaceholder: 'nama@email.com',
                showCancelButton: true
            });

            if (email) {
                const actionCodeSettings = {
                    url: window.location.href, // Link akan kembali ke halaman ini
                    handleCodeInApp: true
                };

                auth.sendSignInLinkToEmail(email, actionCodeSettings)
                    .then(() => {
                        window.localStorage.setItem('emailForSignIn', email); // Simpan email sementara
                        Swal.fire('Link Terkirim!', 'Cek inbox email Anda (termasuk Spam). Klik link di sana untuk masuk.', 'success');
                    })
                    .catch((error) => {
                        Swal.fire('Error', error.message, 'error');
                    });
            }
        }

        // 4. Cek Apakah User Baru Saja Klik Link dari Email?
        if (auth.isSignInWithEmailLink(window.location.href)) {
            let email = window.localStorage.getItem('emailForSignIn');
            if (!email) {
                // Jika email tidak tersimpan (misal ganti browser), tanya lagi
                email = window.prompt('Masukkan email Anda untuk konfirmasi:');
            }
            
            if (email) {
                auth.signInWithEmailLink(email, window.location.href)
                    .then((result) => {
                        window.localStorage.removeItem('emailForSignIn');
                        // Hapus parameter URL agar bersih
                        window.history.replaceState({}, document.title, window.location.pathname);
                        Swal.fire('Sukses', 'Anda berhasil login via email!', 'success');
                    })
                    .catch((error) => {
                        console.error(error);
                        Swal.fire('Gagal', 'Link tidak valid atau kadaluarsa.', 'error');
                    });
            }
        }

        function translateError(code) {
            if (code === 'auth/user-not-found') return "Akun tidak ditemukan. Silakan daftar dulu.";
            if (code === 'auth/wrong-password') return "Password salah.";
            if (code === 'auth/email-already-in-use') return "Email sudah terdaftar.";
            if (code === 'auth/weak-password') return "Password terlalu lemah (min. 6 karakter).";
            if (code === 'auth/invalid-email') return "Format email tidak valid.";
            return "Terjadi kesalahan: " + code;
        }

        function logout() {
            auth.signOut().then(() => {
                exitAdmin();
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'info', title: 'Anda telah keluar.' });
            });
        }

        // ==========================================
        // KONFIGURASI GAME & FOLDER
        // ==========================================
        const GITHUB_USERNAME = 'tanzilhuda1215-source'; 
        const REPO_NAME = 'SisLearn';                    
        const FOLDER_NAME = 'games';                     

        const CUSTOM_ICONS = {
            "space.html": "üöÄ", "glass.html": "üíé", "Pronouncation-Games.html": "üó£Ô∏è",
            "kuis tanda koma.html": "üìù", "Quiz kata sifat kata benda.html": "grammar"
        };

        let spyInterval = null;
        let currentGameTitle = "";

        function parseFileInfo(filename) {
            const dateRegex = /^(\d{4})-(\d{2})-(\d{2})-(.*)\.html$/;
            const match = filename.match(dateRegex);
            if (match) {
                const dateObj = new Date(match[1], match[2] - 1, match[3]);
                return { dateObj, dateDisplay: dateObj.toLocaleDateString('id-ID'), cleanName: match[4].replace(/-/g, ' ').toUpperCase() };
            }
            return { dateObj: new Date(0), dateDisplay: "", cleanName: filename.replace('.html', '').replace(/-/g, ' ').toUpperCase() };
        }

        async function loadContent() {
            const mainContainer = document.getElementById('main-container');
            const rootApiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/${FOLDER_NAME}`;
            try {
                const response = await fetch(rootApiUrl);
                if (!response.ok) throw new Error("Gagal koneksi ke GitHub.");
                const items = await response.json();
                mainContainer.innerHTML = ''; 
                const files = items.filter(i => i.type === 'file' && i.name.endsWith('.html'));
                const folders = items.filter(i => i.type === 'dir');
                if (files.length > 0) renderCategorySection("Game Umum", files);
                await Promise.all(folders.map(async (folder) => {
                    const resp = await fetch(folder.url);
                    const folderItems = await resp.json();
                    const gameInFolder = folderItems.filter(i => i.type === 'file' && i.name.endsWith('.html'));
                    if (gameInFolder.length > 0) renderCategorySection(folder.name.replace(/-/g, ' ').toUpperCase(), gameInFolder);
                }));
            } catch (error) { mainContainer.innerHTML = `<div class="text-red-500 p-4">Error: ${error.message}</div>`; }
        }

        function renderCategorySection(title, files) {
            const container = document.getElementById('main-container');
            const processed = files.map(f => ({ ...f, ...parseFileInfo(f.name) })).sort((a, b) => b.dateObj - a.dateObj);
            let html = `<div class="animate-fade-in order-last"><div class="flex items-center gap-4 mb-6 mt-8"><div class="h-8 w-1 bg-teal-500 rounded-full"></div><h2 class="text-2xl font-bold">${title}</h2></div><div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">`;
            processed.forEach(f => {
                let icon = CUSTOM_ICONS[f.name] || (f.cleanName.includes("MATH") ? "üßÆ" : "üéÆ");
                html += `<div class="bg-slate-800 rounded-2xl p-5 border border-slate-700 hover:border-teal-400 transition-all hover:-translate-y-1 flex flex-col h-full">
                    <div class="flex justify-between mb-4"><span class="text-4xl bg-slate-900/50 w-14 h-14 rounded-xl flex items-center justify-center">${icon}</span>${f.dateDisplay ? `<span class="text-[10px] bg-slate-900 px-2 py-1 rounded border border-teal-900/50 h-fit text-teal-300">üìÖ ${f.dateDisplay}</span>` : ''}</div>
                    <h3 class="text-lg font-bold mb-2">${f.cleanName}</h3>
                    <div class="mt-auto pt-4"><button onclick="openGame('${f.path}', '${f.cleanName}')" class="w-full bg-gradient-to-r from-blue-600 to-teal-600 text-white font-bold py-2 rounded-xl shadow-lg active:scale-95">Mainkan üöÄ</button></div>
                </div>`;
            });
            container.innerHTML += html + `</div></div>`;
        }

        function openGame(path, title) {
            document.getElementById('game-modal').classList.remove('hidden');
            document.getElementById('game-frame').src = path;
            document.getElementById('modal-title').innerText = title;
            currentGameTitle = title;
            startSpying();
        }
        function closeGame() {
            document.getElementById('game-modal').classList.add('hidden');
            document.getElementById('game-frame').src = "";
            clearInterval(spyInterval);
        }

        function startSpying() {
            clearInterval(spyInterval);
            let scoreCaptured = false;
            spyInterval = setInterval(() => {
                if(scoreCaptured) return;
                const iframe = document.getElementById('game-frame');
                try {
                    const doc = iframe.contentDocument || iframe.contentWindow.document;
                    if (doc) {
                        const resultScreen = doc.getElementById('result-screen');
                        if (resultScreen && !resultScreen.classList.contains('hidden')) {
                            const scoreEl = doc.getElementById('final-score');
                            if (scoreEl) {
                                saveToFirebase(currentGameTitle, scoreEl.innerText);
                                scoreCaptured = true;
                                clearInterval(spyInterval);
                                Swal.fire("Misi Selesai!", `Skor ${scoreEl.innerText} tersimpan ke cloud! ‚òÅÔ∏è`, "success");
                            }
                        }
                    }
                } catch (e) {}
            }, 1000);
        }

        // --- DATABASE LOGIC ---
        function saveToFirebase(game, score) {
            if (!currentUser) return;
            const newHistoryRef = db.ref('history/' + currentUser.uid).push();
            newHistoryRef.set({
                game: game,
                score: parseInt(score),
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                dateStr: new Date().toLocaleDateString('id-ID')
            });
        }

        function loadHistoryRealtime() {
            if (!currentUser) return;
            const historyRef = db.ref('history/' + currentUser.uid);
            
            historyRef.on('value', (snapshot) => {
                const container = document.getElementById('history-container');
                const dataRaw = snapshot.val();

                if (!dataRaw) {
                    container.innerHTML = '<p class="text-slate-500 text-sm text-center mt-10">Belum ada data.</p>';
                    return;
                }

                const dataArray = Object.keys(dataRaw).map(key => ({
                    id: key,
                    ...dataRaw[key]
                })).sort((a, b) => b.createdAt - a.createdAt);

                container.innerHTML = '';
                
                dataArray.forEach(data => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = "bg-slate-700/40 p-3 rounded-xl border border-slate-600/50 flex items-center gap-3 group transition-all";
                    
                    const checkbox = `<input type="checkbox" class="admin-check w-5 h-5 accent-red-500 ${isAdmin ? 'block' : 'hidden'}" onchange="toggleSelect('${data.id}')">`;
                    
                    const content = `
                        <div class="flex-grow">
                            <h4 class="font-bold text-sm text-teal-300 line-clamp-1">${data.game}</h4>
                            <p class="text-[10px] text-slate-400">${data.dateStr}</p>
                        </div>
                        <div class="text-right bg-slate-800 px-2 py-1 rounded-lg">
                            <span class="block text-lg font-bold text-yellow-400 leading-none">${data.score}</span>
                        </div>
                    `;

                    itemDiv.innerHTML = checkbox + content;
                    container.appendChild(itemDiv);
                });
            });
        }

        // --- MODE ADMIN ---
        async function adminMode() {
            if (!currentUser) return Swal.fire("Akses Ditolak", "Login dulu bos!", "warning");
            if (isAdmin) { exitAdmin(); return; }

            const { value: password } = await Swal.fire({
                title: 'Masukkan Password Admin',
                input: 'password',
                inputPlaceholder: 'Password...',
                showCancelButton: true
            });

            if (password === "admin") {
                isAdmin = true;
                selectedItems.clear();
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('btn-admin').classList.add('bg-red-600', 'text-white');
                document.getElementById('btn-admin').innerText = "Tutup Admin";
                document.querySelectorAll('.admin-check').forEach(el => el.classList.remove('hidden'));
                Swal.fire("Mode Administrator Aktif", "Silakan pilih data yang ingin dihapus.", "success");
            } else if (password) {
                Swal.fire("Salah Password!", "Anda bukan admin.", "error");
            }
        }

        function exitAdmin() {
            isAdmin = false;
            selectedItems.clear();
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('btn-admin').classList.remove('bg-red-600', 'text-white');
            document.getElementById('btn-admin').innerText = "‚öôÔ∏è Kelola";
            document.querySelectorAll('.admin-check').forEach(el => {
                el.classList.add('hidden');
                el.checked = false;
            });
        }

        window.toggleSelect = function(id) {
            if (selectedItems.has(id)) selectedItems.delete(id);
            else selectedItems.add(id);
        }

        async function deleteSelected() {
            if (selectedItems.size === 0) return Swal.fire("Pilih dulu", "Centang data yang mau dihapus.", "info");

            const result = await Swal.fire({
                title: `Hapus ${selectedItems.size} Data?`,
                text: "Data tidak bisa dikembalikan!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hapus!'
            });

            if (result.isConfirmed) {
                const updates = {};
                selectedItems.forEach(id => {
                    updates[`history/${currentUser.uid}/${id}`] = null;
                });
                
                await db.ref().update(updates);
                Swal.fire("Terhapus!", "Data terpilih sudah hilang.", "success");
                selectedItems.clear();
            }
        }

        async function deleteAll() {
            const result = await Swal.fire({
                title: 'HAPUS SEMUA RIWAYAT?',
                text: "Aksi ini akan menghapus bersih seluruh skor Anda!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Ya, Hancurkan!'
            });

            if (result.isConfirmed) {
                await db.ref(`history/${currentUser.uid}`).remove();
                Swal.fire("Bersih!", "Semua riwayat telah dihapus.", "success");
            }
        }

        loadContent();
    </script>
</body>
</html>
